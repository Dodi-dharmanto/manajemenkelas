<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kehadiran & Nilai Siswa</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client for database and authentication -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS/xlsx for reading Excel files -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Chart.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons for modern icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --gradient-start: #4f46e5;
            --gradient-end: #9333ea;
            --background-image: url('https://images.unsplash.com/photo-1523240795612-9a054b0db644?q=80&w=2070&auto=format&fit=crop');
            
            /* Light Theme Variables */
            --bg-default: #f8fafc; /* slate-50 */
            --bg-card: #ffffff;
            --bg-muted: #f1f5f9; /* slate-100 */
            --border-color: #e2e8f0; /* slate-200 */
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #64748b; /* slate-500 */
            --text-heading: #0f172a; /* slate-900 */
        }
        
        html.dark {
            /* Dark Theme Variables */
            --bg-default: #0f172a; /* slate-900 */
            --bg-card: #1e293b; /* slate-800 */
            --bg-muted: #334155; /* slate-700 */
            --border-color: #334155; /* slate-700 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --text-heading: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-default);
            color: var(--text-secondary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .bg-custom-main {
            background-image: var(--background-image);
            background-size: cover;
            background-position: center;
        }
        .btn-gradient {
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.75);
        }
        .btn-gradient:hover {
            background-position: 100% 0;
            box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .text-primary { color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }
        .ring-primary { --tw-ring-color: var(--primary-color); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-muted); }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .view-section { display: none; }
        .nav-link.active {
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px -2px rgba(116, 79, 168, 0.75);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .btn-kehadiran {
            transition: all 0.2s ease;
        }
        .btn-kehadiran.active {
            transform: scale(1.05);
            color: white;
        }
        .detail-row {
            transition: all 0.3s ease-in-out;
        }
        .summary-row .lucide-chevron-down {
            transition: transform 0.3s ease;
        }
        .summary-row.expanded .lucide-chevron-down {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-[var(--bg-default)] text-[var(--text-secondary)]">

    <!-- ===== LOGIN PAGE ===== -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-slate-100 p-4">
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-2xl flex overflow-hidden">
            <div class="w-full lg:w-1/2 p-8 sm:p-12 flex flex-col justify-center">
                <div class="fade-in">
                    <div class="text-left mb-10">
                        <img id="login-logo" src="https://placehold.co/80x80/3b82f6/white?text=Logo" alt="Logo Aplikasi" class="w-16 h-16 mb-4 rounded-full object-cover">
                        <h1 class="text-3xl font-bold text-gray-800">Selamat Datang Kembali</h1>
                        <p class="text-gray-500 mt-2">Login untuk mengakses dashboard Anda.</p>
                    </div>
                    <form id="login-form">
                        <div class="mb-5">
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="email" name="email" required class="w-full px-4 py-3 bg-slate-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 ring-primary transition-shadow" placeholder="admin@contoh.com">
                        </div>
                        <div class="mb-8">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" name="password" required class="w-full px-4 py-3 bg-slate-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 ring-primary transition-shadow" placeholder="••••••••">
                        </div>
                        <button type="submit" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-lg">Login ke Akun</button>
                    </form>
                    <p id="login-error" class="text-red-500 text-center mt-4 text-sm font-medium"></p>
                </div>
            </div>
            <div class="hidden lg:block lg:w-1/2 bg-custom-main"></div>
        </div>
    </div>

    <!-- ===== MAIN APPLICATION DASHBOARD ===== -->
    <div id="app" class="hidden">
        <div class="relative min-h-screen lg:flex">
            <!-- Mobile Sidebar Overlay -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-20 lg:hidden hidden"></div>

            <!-- Sidebar -->
            <aside id="sidebar" class="fixed inset-y-0 left-0 bg-[var(--bg-card)] w-64 border-r border-[var(--border-color)] flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out z-30 lg:translate-x-0 lg:static">
                <div class="p-4 border-b border-[var(--border-color)] flex items-center space-x-3 h-16 flex-shrink-0">
                    <img id="app-logo" src="https://placehold.co/40x40/3b82f6/white?text=L" alt="Logo" class="w-9 h-9 rounded-full object-cover">
                    <span class="text-lg font-semibold text-[var(--text-heading)]">Dashboard Guru</span>
                </div>
                <nav class="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
                    <a href="#" data-view="siswa" class="nav-link flex items-center px-3 py-2.5 text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-muted)] transition-colors duration-200">
                        <i data-lucide="users" class="w-5 h-5 mr-3"></i> Data Siswa
                    </a>
                    <a href="#" data-view="rekap-siswa" class="nav-link flex items-center px-3 py-2.5 text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-muted)] transition-colors duration-200">
                        <i data-lucide="file-text" class="w-5 h-5 mr-3"></i> Rekapitulasi Siswa
                    </a>
                    <a href="#" data-view="input-kehadiran" class="nav-link flex items-center px-3 py-2.5 text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-muted)] transition-colors duration-200">
                        <i data-lucide="calendar-plus" class="w-5 h-5 mr-3"></i> Input Kehadiran
                    </a>
                    <a href="#" data-view="nilai" class="nav-link flex items-center px-3 py-2.5 text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-muted)] transition-colors duration-200">
                        <i data-lucide="graduation-cap" class="w-5 h-5 mr-3"></i> Nilai Siswa
                    </a>
                    <a href="#" data-view="lembar-penilaian" class="nav-link flex items-center px-3 py-2.5 text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-muted)] transition-colors duration-200">
                        <i data-lucide="clipboard-check" class="w-5 h-5 mr-3"></i> Lembar Penilaian
                    </a>
                    <a href="#" data-view="kelompok" class="nav-link flex items-center px-3 py-2.5 text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-muted)] transition-colors duration-200">
                        <i data-lucide="users-2" class="w-5 h-5 mr-3"></i> Manajemen Kelompok
                    </a>
                    <a href="#" data-view="pengaturan" class="nav-link flex items-center px-3 py-2.5 text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-muted)] transition-colors duration-200">
                        <i data-lucide="settings" class="w-5 h-5 mr-3"></i> Pengaturan
                    </a>
                </nav>
                <div class="p-4 border-t border-[var(--border-color)] space-y-2 flex-shrink-0">
                    <button id="theme-toggle" class="w-full flex items-center justify-center px-4 py-2 text-[var(--text-secondary)] rounded-md hover:bg-[var(--bg-muted)] transition-colors duration-200">
                        <i data-lucide="sun" class="w-5 h-5 mr-3" id="theme-icon-sun"></i>
                        <i data-lucide="moon" class="w-5 h-5 mr-3 hidden" id="theme-icon-moon"></i>
                        <span id="theme-text">Light Mode</span>
                    </button>
                    <button id="logout-button" class="w-full flex items-center justify-center px-4 py-2 text-slate-600 rounded-md hover:bg-red-50 hover:text-red-600 transition-colors duration-200 dark:text-slate-400 dark:hover:bg-red-900/20 dark:hover:text-red-500">
                        <i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Logout
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <!-- Mobile Header -->
                <header class="lg:hidden sticky top-0 bg-[var(--bg-card)]/80 backdrop-blur-sm border-b border-[var(--border-color)] p-4 flex items-center justify-between z-10">
                    <button id="menu-button" class="p-2">
                        <i data-lucide="menu" class="w-6 h-6 text-[var(--text-primary)]"></i>
                    </button>
                    <span class="text-lg font-semibold text-[var(--text-heading)]">Dashboard</span>
                    <div class="w-8"></div>
                </header>

                <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                    
                    <!-- View: Data Siswa -->
                    <div id="view-siswa" class="view-section">
                        <h1 class="text-2xl md:text-3xl font-bold text-[var(--text-heading)] mb-6">Dashboard Siswa</h1>
                        <!-- Rekap Kehadiran Section -->
                        <div class="bg-[var(--bg-card)] p-4 sm:p-6 rounded-xl shadow-md mb-8 border border-[var(--border-color)]">
                            <div class="flex flex-col sm:flex-row justify-between items-start mb-4">
                                <div>
                                    <h2 class="text-lg sm:text-xl font-semibold text-[var(--text-primary)]">Rekapitulasi Kehadiran Kelas</h2>
                                    <p id="rekap-tanggal-display" class="text-sm text-[var(--text-secondary)]">Memuat tanggal...</p>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:items-center gap-4 mt-4 sm:mt-0 w-full sm:w-auto">
                                    <select id="rekap-kelas-filter" class="w-full sm:w-auto px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                    <div class="flex items-center gap-2" id="rekap-periode-filter">
                                        <button data-periode="harian" class="px-4 py-2 text-sm font-medium rounded-lg bg-slate-200 dark:bg-slate-600">Harian</button>
                                        <button data-periode="mingguan" class="px-4 py-2 text-sm font-medium rounded-lg bg-slate-100 dark:bg-slate-700">Mingguan</button>
                                        <button data-periode="bulanan" class="px-4 py-2 text-sm font-medium rounded-lg bg-slate-100 dark:bg-slate-700">Bulanan</button>
                                    </div>
                                    <div id="periode-picker-container" class="relative">
                                        <input type="date" id="rekap-harian-picker" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                        <p id="rekap-mingguan-display" class="hidden px-3 py-2 text-sm text-[var(--text-secondary)] bg-[var(--bg-muted)] rounded-lg"></p>
                                        <input type="month" id="rekap-bulanan-picker" class="hidden w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center mt-6">
                                <div class="md:col-span-1 h-64 flex justify-center items-center">
                                    <canvas id="rekap-chart"></canvas>
                                </div>
                                <div id="rekap-stats-container" class="md:col-span-2 grid grid-cols-2 gap-4"></div>
                            </div>
                        </div>
                        
                        <!-- Ringkasan Kelas Section -->
                        <div class="bg-[var(--bg-card)] p-4 sm:p-6 rounded-xl shadow-md border border-[var(--border-color)]">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                                <h2 class="text-lg sm:text-xl font-semibold text-[var(--text-primary)]">Ringkasan per Kelas</h2>
                                <label for="siswa-file-input" class="cursor-pointer bg-green-500 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-green-600 flex items-center transition-colors">
                                    <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Import Data Siswa
                                </label>
                                <input type="file" id="siswa-file-input" class="hidden" accept=".xlsx, .xls">
                            </div>
                            <div class="overflow-x-auto border border-[var(--border-color)] rounded-lg">
                                <table class="min-w-full bg-[var(--bg-card)]">
                                    <thead class="bg-[var(--bg-muted)]">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-[var(--text-secondary)] w-16">No</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-[var(--text-secondary)]">Kelas</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-[var(--text-secondary)]">Jumlah Siswa</th>
                                            <th class="py-3 px-4 text-left text-sm font-semibold text-[var(--text-secondary)] w-24">Detail</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kelas-summary-body" class="divide-y divide-[var(--border-color)]"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- View: Rekapitulasi Siswa -->
                    <div id="view-rekap-siswa" class="view-section">
                        <h1 class="text-2xl md:text-3xl font-bold text-[var(--text-heading)] mb-6">Rekapitulasi Siswa</h1>
                        <div class="bg-[var(--bg-card)] p-4 sm:p-6 rounded-xl shadow-md mb-8 border border-[var(--border-color)]">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <h2 class="text-lg sm:text-xl font-semibold text-[var(--text-primary)]">Pilih Siswa & Periode</h2>
                                <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full sm:w-auto">
                                    <select id="rekap-siswa-kelas-filter" class="w-full sm:w-auto px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                    <select id="rekap-siswa-murid-filter" class="w-full sm:w-auto px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)] hidden"></select>
                                    <div class="flex items-center gap-2" id="rekap-siswa-periode-filter">
                                        <button data-periode="harian" class="px-4 py-2 text-sm font-medium rounded-lg bg-slate-200 dark:bg-slate-600">Harian</button>
                                        <button data-periode="mingguan" class="px-4 py-2 text-sm font-medium rounded-lg bg-slate-100 dark:bg-slate-700">Mingguan</button>
                                        <button data-periode="bulanan" class="px-4 py-2 text-sm font-medium rounded-lg bg-slate-100 dark:bg-slate-700">Bulanan</button>
                                    </div>
                                    <div id="rekap-siswa-picker-container" class="relative">
                                        <input type="date" id="rekap-siswa-harian-picker" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                        <p id="rekap-siswa-mingguan-display" class="hidden px-3 py-2 text-sm text-[var(--text-secondary)] bg-[var(--bg-muted)] rounded-lg"></p>
                                        <input type="month" id="rekap-siswa-bulanan-picker" class="hidden w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="rekap-siswa-content-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
                            <!-- Student rekap cards will be injected here -->
                        </div>
                    </div>

                    <!-- View: Input Kehadiran -->
                    <div id="view-input-kehadiran" class="view-section">
                        <h1 class="text-2xl md:text-3xl font-bold text-[var(--text-heading)] mb-6">Input Kehadiran Harian</h1>
                        <div class="bg-[var(--bg-card)] p-4 sm:p-6 rounded-xl shadow-md border border-[var(--border-color)]">
                            <div class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
                                <input type="date" id="kehadiran-tanggal" class="w-full sm:w-auto px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                                    <select id="kehadiran-kelas-filter" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                    <input type="text" id="kehadiran-nama-filter" placeholder="Cari Nama Siswa..." class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                </div>
                            </div>
                            <div id="kehadiran-list-container" class="space-y-3"></div>
                        </div>
                    </div>

                    <!-- View: Nilai Siswa -->
                    <div id="view-nilai" class="view-section">
                        <h1 class="text-2xl md:text-3xl font-bold text-[var(--text-heading)] mb-6">Rekapitulasi Nilai Projek</h1>
                        
                        <!-- Rekapitulasi Nilai Projek -->
                        <div class="bg-[var(--bg-card)] p-4 sm:p-6 rounded-xl shadow-md mb-8 border border-[var(--border-color)]">
                            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                                <h2 class="text-lg sm:text-xl font-semibold text-[var(--text-primary)]">Rekapitulasi Nilai Projek</h2>
                                <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                                    <select id="rekap-nilai-kelas-filter" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                    <select id="rekap-nilai-mapel-filter" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                    <button id="export-nilai-projek" class="w-full sm:w-auto bg-green-500 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-green-600 flex items-center justify-center transition-colors">
                                        <i data-lucide="download" class="w-4 h-4 mr-2"></i> Export
                                    </button>
                                </div>
                            </div>
                            <div id="rekap-nilai-container" class="overflow-x-auto border border-[var(--border-color)] rounded-lg">
                                <!-- Rekap table will be injected here -->
                            </div>
                        </div>
                        
                        <div class="bg-[var(--bg-card)] p-6 rounded-xl shadow-md border border-[var(--border-color)] mt-8">
                            <h2 class="text-xl font-semibold text-[var(--text-primary)] border-b border-[var(--border-color)] pb-3 mb-4">Manajemen Mapel & Projek</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="font-semibold text-[var(--text-primary)] mb-2">Tambah Mapel</h3>
                                    <form id="add-mapel-form" class="flex gap-2">
                                        <input type="text" id="new-mapel-name" placeholder="Nama Mapel" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                        <button type="submit" class="btn-gradient text-white p-2 rounded-lg flex-shrink-0"><i data-lucide="plus"></i></button>
                                    </form>
                                    <ul id="mapel-list" class="mt-3 space-y-1 text-sm h-24 overflow-y-auto"></ul>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-[var(--text-primary)] mb-2">Tambah Projek</h3>
                                    <form id="add-projek-form" class="space-y-2">
                                        <select id="projek-mapel-select" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                        <div class="flex gap-2">
                                            <input type="text" id="new-projek-name" placeholder="Nama Projek" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                            <button type="submit" class="btn-gradient text-white p-2 rounded-lg flex-shrink-0"><i data-lucide="plus"></i></button>
                                        </div>
                                    </form>
                                    <ul id="projek-list" class="mt-3 space-y-1 text-sm h-24 overflow-y-auto"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- View: Lembar Penilaian -->
                    <div id="view-lembar-penilaian" class="view-section">
                        <h1 class="text-2xl md:text-3xl font-bold text-[var(--text-heading)] mb-6">Lembar Penilaian Projek</h1>
                        <div class="bg-[var(--bg-card)] p-4 sm:p-6 rounded-xl shadow-md mb-8 border border-[var(--border-color)]">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <h2 class="text-lg sm:text-xl font-semibold text-[var(--text-primary)]">Filter Penilaian</h2>
                                <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full sm:w-auto">
                                    <select id="lp-projek-filter" class="w-full sm:w-auto px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                    <select id="lp-kelas-filter" class="w-full sm:w-auto px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                    <select id="lp-kelompok-filter" class="w-full sm:w-auto px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                </div>
                            </div>
                        </div>
                        <div id="lembar-penilaian-container" class="overflow-x-auto border border-[var(--border-color)] rounded-lg bg-[var(--bg-card)]">
                            <!-- Assessment sheet will be injected here -->
                        </div>
                        <div id="lembar-penilaian-actions" class="mt-6 text-right hidden">
                            <button id="save-penilaian-btn" class="btn-gradient text-white font-bold py-2 px-6 rounded-lg">Simpan Penilaian</button>
                        </div>
                    </div>

                    <!-- View: Manajemen Kelompok -->
                    <div id="view-kelompok" class="view-section">
                        <h1 class="text-2xl md:text-3xl font-bold text-[var(--text-heading)] mb-6">Manajemen Kelompok</h1>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Kolom Kiri: Pengaturan Kelompok -->
                            <div class="bg-[var(--bg-card)] p-6 rounded-xl shadow-md border border-[var(--border-color)]">
                                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                                    <h2 class="text-xl font-semibold text-[var(--text-primary)]">Pengaturan Kelompok</h2>
                                    <select id="kelompok-kelas-filter" class="w-full sm:w-auto px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]"></select>
                                </div>
                                <div class="mb-6">
                                    <h3 class="font-semibold text-[var(--text-primary)] mb-2">Buat Kelompok Baru</h3>
                                    <form id="add-kelompok-form" class="flex gap-2">
                                        <input type="text" id="new-kelompok-name" placeholder="Nama Kelompok (e.g., Kelompok 1)" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                        <button type="submit" class="btn-gradient text-white p-2 rounded-lg flex-shrink-0"><i data-lucide="plus"></i></button>
                                    </form>
                                </div>
                                <div class="mb-4">
                                    <label for="kelompok-nama-filter" class="block text-sm font-medium text-[var(--text-primary)] mb-2">Cari Siswa</label>
                                    <input type="text" id="kelompok-nama-filter" placeholder="Ketik nama siswa..." class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                </div>
                                <div>
                                    <h3 class="font-semibold text-[var(--text-primary)] mb-2">Siswa Belum Berkelompok</h3>
                                    <div id="unassigned-students-list" class="space-y-2 h-64 overflow-y-auto p-2 bg-[var(--bg-muted)] rounded-lg">
                                        <!-- Daftar siswa tanpa kelompok -->
                                    </div>
                                </div>
                            </div>
                            <!-- Kolom Kanan: Rekapitulasi Kelompok -->
                            <div class="bg-[var(--bg-card)] p-6 rounded-xl shadow-md border border-[var(--border-color)]">
                                <h2 class="text-xl font-semibold text-[var(--text-primary)] mb-4">Rekapitulasi Kelompok</h2>
                                <div id="rekap-kelompok-container" class="space-y-4 h-[35rem] overflow-y-auto">
                                    <!-- Rekap kelompok per kelas -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- View: Pengaturan -->
                    <div id="view-pengaturan" class="view-section">
                        <h1 class="text-2xl md:text-3xl font-bold text-[var(--text-heading)] mb-6">Pengaturan Aplikasi</h1>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-[var(--bg-card)] p-6 rounded-xl shadow-md border border-[var(--border-color)]">
                                <h2 class="text-xl font-semibold text-[var(--text-primary)] border-b border-[var(--border-color)] pb-3 mb-4">Kustomisasi Tampilan</h2>
                                <div class="space-y-5 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-secondary)]">Warna Utama</label>
                                        <input type="color" id="color-picker" class="w-full h-10 p-1 border border-[var(--border-color)] rounded-lg mt-1 cursor-pointer">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-secondary)]">Logo Aplikasi (Rasio 1:1)</label>
                                        <input type="file" id="logo-upload" class="w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary hover:file:bg-blue-100 mt-1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-secondary)]">Background Login</label>
                                        <input type="file" id="background-upload" class="w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary hover:file:bg-blue-100 mt-1">
                                    </div>
                                    <button id="save-settings" class="w-full btn-gradient text-white font-bold py-2.5 rounded-lg mt-4">Simpan Perubahan</button>
                                </div>
                            </div>
                            <div class="bg-[var(--bg-card)] p-6 rounded-xl shadow-md border border-[var(--border-color)]">
                                <h2 class="text-xl font-semibold text-[var(--text-primary)] border-b border-[var(--border-color)] pb-3 mb-4">Manajemen Admin</h2>
                                <form id="add-admin-form" class="space-y-5 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-secondary)]">Email Admin Baru</label>
                                        <input type="email" id="new-admin-email" placeholder="email@baru.com" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg mt-1 focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-secondary)]">Password Admin Baru</label>
                                        <input type="password" id="new-admin-password" placeholder="••••••••" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-lg mt-1 focus:outline-none focus:ring-2 ring-primary bg-[var(--bg-card)]">
                                    </div>
                                    <button type="submit" class="w-full btn-gradient text-white font-bold py-2.5 rounded-lg">Tambah Admin</button>
                                </form>
                                <div class="mt-6">
                                    <h3 class="font-semibold text-[var(--text-primary)] mb-2">Daftar Admin</h3>
                                    <ul id="admin-list" class="space-y-2 h-24 overflow-y-auto"></ul>
                                </div>
                            </div>
                            <div class="bg-[var(--bg-card)] p-6 rounded-xl shadow-md lg:col-span-2 border border-[var(--border-color)]">
                                 <h2 class="text-xl font-semibold mb-3 text-red-600">Zona Berbahaya</h2>
                                 <div class="space-y-4">
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                                        <div>
                                            <h3 class="font-semibold text-[var(--text-primary)]">Reset Data Nilai</h3>
                                            <p class="text-sm text-[var(--text-secondary)] mt-1">Menghapus semua data nilai projek (individual & kelompok).</p>
                                        </div>
                                        <button id="reset-nilai-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors mt-3 sm:mt-0 flex-shrink-0">Reset Nilai</button>
                                    </div>
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                                        <div>
                                            <h3 class="font-semibold text-[var(--text-primary)]">Reset Data Kehadiran</h3>
                                            <p class="text-sm text-[var(--text-secondary)] mt-1">Menghapus semua data kehadiran siswa.</p>
                                        </div>
                                        <button id="reset-kehadiran-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors mt-3 sm:mt-0 flex-shrink-0">Reset Kehadiran</button>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-300 ease-in-out z-50">
        <p id="toast-message" class="font-medium">Operasi berhasil!</p>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-[var(--bg-card)] p-6 rounded-xl shadow-lg w-full max-w-md text-center border border-[var(--border-color)]">
            <h3 id="modal-title" class="text-lg font-bold text-[var(--text-heading)] mb-2">Konfirmasi Tindakan</h3>
            <p id="modal-message" class="text-sm text-[var(--text-secondary)] mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 text-[var(--text-primary)]">Batal</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Konfirmasi</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // =================================================================================
    // SUPABASE SETUP
    // =================================================================================
    const SUPABASE_URL = 'https://mkjdwkrxogsvqwcmzbht.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ramR3a3J4b2dzdnF3Y216Ymh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTc4ODUsImV4cCI6MjA3MTI3Mzg4NX0.x3xmt-gKbHzJ2HU23wrRHomJ7eKDHsH2oGhLdigcm0M';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =================================================================================
    // GLOBAL STATE & SELECTORS
    // =================================================================================
    let allStudents = [];
    let allClasses = [];
    let allMapel = [];
    let allProjek = [];
    let allPenilaianProjek = [];
    let allKelompok = [];
    let allKelompokAnggota = [];
    let allAdmins = [];
    let rekapChartInstance = null;
    let rekapSiswaChartInstances = {};

    const loginPage = document.getElementById('login-page');
    const appPage = document.getElementById('app');
    
    // =================================================================================
    // THEME LOGIC
    // =================================================================================
    const themeToggle = document.getElementById('theme-toggle');
    const themeText = document.getElementById('theme-text');
    const sunIcon = document.getElementById('theme-icon-sun');
    const moonIcon = document.getElementById('theme-icon-moon');

    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            themeText.textContent = 'Dark Mode';
            sunIcon.classList.add('hidden');
            moonIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            themeText.textContent = 'Light Mode';
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
        }
        if (document.getElementById('view-siswa').style.display === 'block') renderRekapKehadiran();
    }

    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(savedTheme);

    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });


    // =================================================================================
    // UTILITY FUNCTIONS
    // =================================================================================
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.className = `fixed top-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg transform transition-transform duration-300 ease-in-out z-50 ${isError ? 'bg-red-500' : 'bg-green-600'}`;
        toast.classList.remove('translate-x-[120%]');
        setTimeout(() => { toast.classList.add('translate-x-[120%]'); }, 3000);
    }

    function switchView(viewId) {
        document.querySelectorAll('.view-section').forEach(section => {
            section.style.display = section.id === `view-${viewId}` ? 'block' : 'none';
        });
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.toggle('active', link.dataset.view === viewId);
        });
    }

    // =================================================================================
    // AUTHENTICATION
    // =================================================================================
    async function checkSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            loginPage.classList.add('hidden');
            appPage.classList.remove('hidden');
            lucide.createIcons();
            initializeApp();
        } else {
            loginPage.classList.remove('hidden');
            appPage.classList.add('hidden');
            lucide.createIcons();
        }
    }
    
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const { error } = await supabase.auth.signInWithPassword({
            email: e.target.email.value,
            password: e.target.password.value
        });
        error ? document.getElementById('login-error').textContent = 'Login gagal: ' + error.message : checkSession();
    });

    document.getElementById('logout-button').addEventListener('click', async () => {
        await supabase.auth.signOut();
        checkSession();
    });

    // =================================================================================
    // INITIALIZATION
    // =================================================================================
    async function initializeApp() {
        switchView('siswa');
        await Promise.all([
            loadSiswaData(),
            loadMapelData(),
            loadProjekData(),
            loadPenilaianProjekData(),
            loadKelompokData(),
            loadKelompokAnggotaData(),
            loadAdminData()
        ]);
        
        populateClassFilters();
        populateMapelSelects();
        populateLpProjekFilter();
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('kehadiran-tanggal').value = today;
        document.getElementById('rekap-harian-picker').value = today;
        document.getElementById('rekap-bulanan-picker').value = today.substring(0, 7);
        document.getElementById('rekap-siswa-harian-picker').value = today;
        document.getElementById('rekap-siswa-bulanan-picker').value = today.substring(0, 7);
        
        renderInputKehadiranList();
        renderRekapKehadiran();
        renderKelasSummaryTable();
        loadAppSettings();
        renderRekapNilaiProjek();
        renderKelompokManagementUI();
        setupEventListeners();
    }

    // =================================================================================
    // DATA & UI RENDERING
    // =================================================================================
    async function loadSiswaData() {
        const { data, error } = await supabase.from('siswa').select('*').order('kelas').order('nama');
        if (error) return showToast('Gagal memuat data siswa.', true);
        
        allStudents = data;
        allClasses = [...new Set(data.map(s => s.kelas))].sort();
    }

    async function loadMapelData() {
        const { data, error } = await supabase.from('mapel').select('*').order('nama_mapel');
        if (error) return showToast('Gagal memuat data mapel.', true);
        allMapel = data;
        renderMapelList();
    }

    async function loadProjekData() {
        const { data, error } = await supabase.from('projek').select('*, mapel(nama_mapel)').order('nama_projek');
        if (error) return showToast('Gagal memuat data projek.', true);
        allProjek = data;
        renderProjekList();
    }

    async function loadPenilaianProjekData() {
        const { data, error } = await supabase.from('penilaian_projek').select('*');
        if (error) return showToast('Gagal memuat data penilaian.', true);
        allPenilaianProjek = data;
    }
    
    async function loadKelompokData() {
        const { data, error } = await supabase.from('kelompok').select('*');
        if (error) return showToast('Gagal memuat data kelompok.', true);
        allKelompok = data;
    }

    async function loadKelompokAnggotaData() {
        const { data, error } = await supabase.from('kelompok_anggota').select('*');
        if (error) return showToast('Gagal memuat anggota kelompok.', true);
        allKelompokAnggota = data;
    }

    async function loadAdminData() {
        const { data, error } = await supabase.from('admin_users').select('*');
        if (error) return showToast('Gagal memuat data admin.', true);
        allAdmins = data;
        renderAdminList();
    }
    
    function populateClassFilters() {
        const filters = [
            document.getElementById('kehadiran-kelas-filter'),
            document.getElementById('rekap-kelas-filter'),
            document.getElementById('rekap-nilai-kelas-filter'),
            document.getElementById('kelompok-kelas-filter'),
            document.getElementById('rekap-siswa-kelas-filter'),
            document.getElementById('lp-kelas-filter')
        ];
        filters.forEach(filter => {
            if(filter) {
                const isRekap = ['rekap-nilai-kelas-filter', 'rekap-siswa-kelas-filter'].includes(filter.id);
                const isKelompok = ['kelompok-kelas-filter', 'lp-kelas-filter'].includes(filter.id);
                let defaultOption = isRekap || isKelompok ? 'Pilih Kelas' : 'Semua Kelas';
                filter.innerHTML = `<option value="">${defaultOption}</option>`;
                allClasses.forEach(kelas => {
                    filter.innerHTML += `<option value="${kelas}">${kelas}</option>`;
                });
            }
        });
    }

    function populateMapelSelects() {
        const selects = [
            document.getElementById('projek-mapel-select'),
            document.getElementById('rekap-nilai-mapel-filter'),
        ];
        selects.forEach(select => {
            if(select) {
                const isRekap = select.id === 'rekap-nilai-mapel-filter';
                select.innerHTML = `<option value="">${isRekap ? 'Pilih Mapel' : 'Pilih Mapel'}</option>`;
                allMapel.forEach(mapel => {
                    select.innerHTML += `<option value="${mapel.id}">${mapel.nama_mapel}</option>`;
                });
            }
        });
    }

    function populateLpProjekFilter() {
        const filter = document.getElementById('lp-projek-filter');
        if (!filter) return;
        filter.innerHTML = `<option value="">Pilih Projek</option>`;
        allProjek.forEach(projek => {
            filter.innerHTML += `<option value="${projek.id}">${projek.nama_projek} (${projek.mapel.nama_mapel})</option>`;
        });
    }

    function renderMapelList() {
        const list = document.getElementById('mapel-list');
        if(list) {
            list.innerHTML = allMapel.map(m => `<li class="p-1.5 bg-slate-100 dark:bg-slate-700 rounded">${m.nama_mapel}</li>`).join('');
        }
    }

    function renderProjekList() {
        const list = document.getElementById('projek-list');
        if(list) {
            list.innerHTML = allProjek.map(p => `<li class="p-1.5 bg-slate-100 dark:bg-slate-700 rounded">${p.nama_projek} <span class="text-xs text-slate-500 dark:text-slate-400">(${p.mapel.nama_mapel})</span></li>`).join('');
        }
    }
    
    function renderKelasSummaryTable() {
        const summaryBody = document.getElementById('kelas-summary-body');
        if (!allClasses.length) {
            summaryBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-slate-500">Belum ada data siswa. Silakan import terlebih dahulu.</td></tr>`;
            return;
        }

        summaryBody.innerHTML = allClasses.map((kelas, index) => {
            const studentsInClass = allStudents.filter(s => s.kelas === kelas);
            const studentListHtml = studentsInClass.map(s => 
                `<li class="flex justify-between py-1 px-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded">
                    <span>${s.nama}</span>
                    <span class="text-slate-500 dark:text-slate-400">${s.nis}</span>
                </li>`
            ).join('');

            return `
                <tr class="summary-row cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50" data-kelas="${kelas}">
                    <td class="py-3 px-4">${index + 1}</td>
                    <td class="py-3 px-4 font-medium text-[var(--text-primary)]">${kelas}</td>
                    <td class="py-3 px-4">${studentsInClass.length} Siswa</td>
                    <td class="py-3 px-4"><i data-lucide="chevron-down" class="mx-auto"></i></td>
                </tr>
                <tr class="detail-row hidden" data-detail-for="${kelas}">
                    <td colspan="4" class="p-0">
                        <div class="bg-slate-50 dark:bg-slate-900/50 p-4">
                            <h4 class="font-semibold mb-2 text-[var(--text-primary)]">Daftar Siswa Kelas ${kelas}</h4>
                            <ul class="space-y-1 text-sm">${studentListHtml}</ul>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        lucide.createIcons();
    }

    function renderAdminList() {
        const adminList = document.getElementById('admin-list');
        if(adminList) {
            adminList.innerHTML = allAdmins.map(admin => `
                <li class="flex justify-between items-center p-2 bg-slate-100 dark:bg-slate-700 rounded">
                    <span class="text-sm">${admin.email}</span>
                    <button data-admin-id="${admin.id}" class="remove-admin-btn text-red-500 hover:text-red-700">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </li>
            `).join('');
            lucide.createIcons();
        }
    }

    // =================================================================================
    // KEHADIRAN LOGIC (INPUT & REKAP)
    // =================================================================================
    async function renderInputKehadiranList() {
        const kehadiranContainer = document.getElementById('kehadiran-list-container');
        const tanggal = document.getElementById('kehadiran-tanggal').value;
        const kelas = document.getElementById('kehadiran-kelas-filter').value;
        const nama = document.getElementById('kehadiran-nama-filter').value.toLowerCase();

        const { data: attendanceData, error } = await supabase.from('kehadiran').select('siswa_id, keterangan').eq('tanggal', tanggal);
        if (error) return showToast('Gagal memuat data kehadiran harian.', true);

        const attendanceMap = new Map(attendanceData.map(a => [a.siswa_id, a.keterangan]));

        const filteredStudents = allStudents.filter(s => 
            (kelas === '' || s.kelas === kelas) && s.nama.toLowerCase().includes(nama)
        );

        if (filteredStudents.length === 0) {
            kehadiranContainer.innerHTML = `<p class="text-center text-slate-500 p-4">Tidak ada siswa yang cocok dengan filter.</p>`;
            return;
        }

        kehadiranContainer.innerHTML = filteredStudents.map(siswa => {
            const status = attendanceMap.get(siswa.id);
            return `
            <div class="flex items-center justify-between p-3 bg-[var(--bg-muted)] rounded-lg">
                <div>
                    <p class="font-semibold text-[var(--text-primary)]">${siswa.nama}</p>
                    <p class="text-xs text-[var(--text-secondary)]">NIS: ${siswa.nis} | Kelas: ${siswa.kelas}</p>
                </div>
                <div class="flex gap-2" data-siswa-id="${siswa.id}">
                    <button data-status="Ijin" class="btn-kehadiran px-4 py-1.5 text-sm font-medium rounded-md ${status === 'Ijin' ? 'active bg-blue-500' : 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300'}">Ijin</button>
                    <button data-status="Sakit" class="btn-kehadiran px-4 py-1.5 text-sm font-medium rounded-md ${status === 'Sakit' ? 'active bg-amber-500' : 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300'}">Sakit</button>
                    <button data-status="Alpa" class="btn-kehadiran px-4 py-1.5 text-sm font-medium rounded-md ${status === 'Alpa' ? 'active bg-red-500' : 'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300'}">Alpa</button>
                </div>
            </div>`;
        }).join('');
    }

    async function handleKehadiranClick(e) {
        if (!e.target.matches('.btn-kehadiran')) return;
        const button = e.target;
        const parent = button.parentElement;
        const siswaId = parent.dataset.siswaId;
        const status = button.dataset.status;
        const tanggal = document.getElementById('kehadiran-tanggal').value;
        const isActive = button.classList.contains('active');

        const dbAction = isActive 
            ? supabase.from('kehadiran').delete().match({ siswa_id: siswaId, tanggal: tanggal })
            : supabase.from('kehadiran').upsert({ siswa_id: siswaId, tanggal: tanggal, keterangan: status }, { onConflict: 'siswa_id,tanggal' });

        const { error } = await dbAction;
        if (error) return showToast('Gagal mengubah status.', true);
        
        parent.querySelectorAll('.btn-kehadiran').forEach(btn => {
            const isCurrent = btn.dataset.status === status;
            btn.classList.remove('active', 'bg-blue-500', 'bg-amber-500', 'bg-red-500');
            if (isCurrent && !isActive) {
                btn.classList.add('active', `bg-${status === 'Ijin' ? 'blue' : status === 'Sakit' ? 'amber' : 'red'}-500`);
            }
        });
    }

    async function renderRekapKehadiran() {
        const kelas = document.getElementById('rekap-kelas-filter').value;
        const periode = document.querySelector('#rekap-periode-filter .bg-slate-200, #rekap-periode-filter .dark\\:bg-slate-600').dataset.periode;
        const statsContainer = document.getElementById('rekap-stats-container');
        
        document.getElementById('rekap-tanggal-display').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        statsContainer.innerHTML = `<p class="col-span-full text-center">Memuat data rekap...</p>`;

        const { startDate, endDate } = getPeriodeDates(periode);

        const studentsInClass = allStudents.filter(s => kelas === '' || s.kelas === kelas);
        if (studentsInClass.length === 0) {
            statsContainer.innerHTML = `<p class="col-span-full text-center">Tidak ada siswa di kelas ini.</p>`;
            if(rekapChartInstance) rekapChartInstance.destroy();
            return;
        }

        const { data, error } = await supabase.from('kehadiran').select('keterangan')
            .in('siswa_id', studentsInClass.map(s => s.id))
            .gte('tanggal', startDate)
            .lte('tanggal', endDate);

        if (error) return showToast('Gagal memuat data rekap.', true);

        const rekap = { Sakit: 0, Ijin: 0, Alpa: 0 };
        data.forEach(d => { if(rekap[d.keterangan] !== undefined) rekap[d.keterangan]++; });

        const totalAbsen = rekap.Sakit + rekap.Ijin + rekap.Alpa;
        const totalHariEfektif = Math.round((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
        const totalSlotHadir = studentsInClass.length * totalHariEfektif;
        const hadir = Math.max(0, totalSlotHadir - totalAbsen);

        statsContainer.innerHTML = `
            <div class="p-4 bg-green-100 dark:bg-green-900/50 rounded-lg"><p class="text-sm text-green-700 dark:text-green-300">Hadir</p><p class="text-2xl font-bold text-green-800 dark:text-green-200">${hadir}</p></div>
            <div class="p-4 bg-amber-100 dark:bg-amber-900/50 rounded-lg"><p class="text-sm text-amber-700 dark:text-amber-300">Sakit</p><p class="text-2xl font-bold text-amber-800 dark:text-amber-200">${rekap.Sakit}</p></div>
            <div class="p-4 bg-blue-100 dark:bg-blue-900/50 rounded-lg"><p class="text-sm text-blue-700 dark:text-blue-300">Ijin</p><p class="text-2xl font-bold text-blue-800 dark:text-blue-200">${rekap.Ijin}</p></div>
            <div class="p-4 bg-red-100 dark:bg-red-900/50 rounded-lg"><p class="text-sm text-red-700 dark:text-red-300">Alpa</p><p class="text-2xl font-bold text-red-800 dark:text-red-200">${rekap.Alpa}</p></div>
        `;
        
        updateRekapChart([hadir, rekap.Sakit, rekap.Ijin, rekap.Alpa]);
    }

    function updateRekapChart(data) {
        const ctx = document.getElementById('rekap-chart').getContext('2d');
        if (rekapChartInstance) {
            rekapChartInstance.destroy();
        }
        rekapChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Hadir', 'Sakit', 'Ijin', 'Alpa'],
                datasets: [{
                    data: data,
                    backgroundColor: ['#22c55e', '#f59e0b', '#3b82f6', '#ef4444'],
                    borderColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#ffffff',
                    borderWidth: 4,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '70%',
                plugins: { legend: { display: false } }
            }
        });
    }

    function getPeriodeDates(periode, prefix = 'rekap') {
        let pickerValue;
        const today = new Date();
        if (periode === 'harian') {
            pickerValue = document.getElementById(`${prefix}-harian-picker`).value;
            const date = pickerValue ? new Date(pickerValue) : today;
            const selectedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1).toISOString().split('T')[0];
            return { startDate: selectedDate, endDate: selectedDate };
        }
        if (periode === 'mingguan') {
            const dayOfWeek = today.getDay();
            const firstDayOfWeek = new Date(today.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)));
            const weekEnd = new Date(new Date(firstDayOfWeek).setDate(firstDayOfWeek.getDate() + 6));
            return { 
                startDate: firstDayOfWeek.toISOString().split('T')[0], 
                endDate: weekEnd.toISOString().split('T')[0] 
            };
        }
        if (periode === 'bulanan') {
            pickerValue = document.getElementById(`${prefix}-bulanan-picker`).value;
            const [year, month] = pickerValue.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1).toISOString().split('T')[0];
            const endDate = new Date(year, month, 0).toISOString().split('T')[0];
            return { startDate, endDate };
        }
    }

    // =================================================================================
    // NILAI SISWA LOGIC
    // =================================================================================
    function renderRekapNilaiProjek() {
        const container = document.getElementById('rekap-nilai-container');
        const kelas = document.getElementById('rekap-nilai-kelas-filter').value;
        const mapelId = document.getElementById('rekap-nilai-mapel-filter').value;

        if (kelas === '' || mapelId === '') {
            container.innerHTML = `<p class="text-center p-8 text-[var(--text-secondary)]">Silakan pilih kelas dan mata pelajaran untuk melihat rekapitulasi nilai.</p>`;
            return;
        }

        const studentsInClass = allStudents.filter(s => s.kelas === kelas);
        const projectsInMapel = allProjek.filter(p => p.mapel_id == mapelId);

        if (studentsInClass.length === 0) {
            container.innerHTML = `<p class="text-center p-8 text-[var(--text-secondary)]">Tidak ada siswa di kelas ini.</p>`;
            return;
        }
        if (projectsInMapel.length === 0) {
            container.innerHTML = `<p class="text-center p-8 text-[var(--text-secondary)]">Tidak ada projek untuk mata pelajaran ini.</p>`;
            return;
        }

        let tableHTML = `<table class="min-w-full bg-[var(--bg-card)] text-sm" id="rekap-nilai-table">
            <thead class="bg-[var(--bg-muted)]">
                <tr>
                    <th class="py-3 px-4 text-left font-semibold text-[var(--text-secondary)]">Nama Siswa</th>
                    ${projectsInMapel.map(p => `<th class="py-3 px-4 text-center font-semibold text-[var(--text-secondary)]">${p.nama_projek}</th>`).join('')}
                    <th class="py-3 px-4 text-center font-bold text-[var(--text-primary)] bg-slate-200 dark:bg-slate-600">Nilai Akhir</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-[var(--border-color)]">`;
        
        studentsInClass.forEach(siswa => {
            let totalNilaiAkhir = 0;
            let jumlahProjekDenganNilai = 0;

            tableHTML += `<tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                <td class="py-2 px-4 font-medium text-[var(--text-primary)]">${siswa.nama}</td>`;
            
            projectsInMapel.forEach(projek => {
                const penilaian = allPenilaianProjek.find(n => n.siswa_id === siswa.id && n.projek_id === projek.id);
                let nilaiAkhirProjek = '-';
                if (penilaian && penilaian.nilai_akhir !== null) {
                    nilaiAkhirProjek = penilaian.nilai_akhir;
                    totalNilaiAkhir += parseFloat(nilaiAkhirProjek);
                    jumlahProjekDenganNilai++;
                }
                tableHTML += `<td class="py-2 px-4 text-center">${nilaiAkhirProjek}</td>`;
            });

            const rataRataKeseluruhan = jumlahProjekDenganNilai > 0 ? (totalNilaiAkhir / jumlahProjekDenganNilai).toFixed(2) : '-';
            tableHTML += `<td class="py-2 px-4 text-center font-bold text-[var(--text-primary)] bg-slate-100 dark:bg-slate-700">${rataRataKeseluruhan}</td>`;
            tableHTML += `</tr>`;
        });

        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    }

    // =================================================================================
    // LEMBAR PENILAIAN LOGIC
    // =================================================================================
    async function renderLembarPenilaian() {
        const container = document.getElementById('lembar-penilaian-container');
        const actions = document.getElementById('lembar-penilaian-actions');
        const projekId = document.getElementById('lp-projek-filter').value;
        const kelas = document.getElementById('lp-kelas-filter').value;
        const kelompokId = document.getElementById('lp-kelompok-filter').value;

        container.innerHTML = `<p class="text-center p-8 text-[var(--text-secondary)]">Silakan pilih Projek, Kelas, dan Kelompok untuk memulai penilaian.</p>`;
        actions.classList.add('hidden');

        if (!projekId || !kelas || !kelompokId) return;

        const anggotaIds = allKelompokAnggota.filter(a => a.kelompok_id == kelompokId).map(a => a.siswa_id);
        const anggota = allStudents.filter(s => anggotaIds.includes(s.id));

        if (anggota.length === 0) {
            container.innerHTML = `<p class="text-center p-8 text-[var(--text-secondary)]">Tidak ada anggota di kelompok ini.</p>`;
            return;
        }

        const existingPenilaian = allPenilaianProjek.filter(p => p.projek_id == projekId && anggotaIds.includes(p.siswa_id));
        const penilaianMap = new Map(existingPenilaian.map(p => [p.siswa_id, p]));

        const tableHeader = `
            <th class="p-3 text-left font-semibold text-[var(--text-secondary)]">Nama Siswa</th>
            <th class="p-3 text-center font-semibold text-[var(--text-secondary)] w-28">Kreativitas</th>
            <th class="p-3 text-center font-semibold text-[var(--text-secondary)] w-28">Kerja Sama</th>
            <th class="p-3 text-center font-semibold text-[var(--text-secondary)] w-28">Hasil Akhir</th>
            <th class="p-3 text-left font-semibold text-[var(--text-secondary)]">Catatan</th>
            <th class="p-3 text-center font-semibold text-[var(--text-primary)] w-28">Nilai Akhir</th>
        `;

        const tableBody = anggota.map(siswa => {
            const penilaian = penilaianMap.get(siswa.id) || {};
            return `
                <tr class="border-b border-[var(--border-color)] penilaian-row" data-siswa-id="${siswa.id}">
                    <td class="p-3 font-medium text-[var(--text-primary)]">${siswa.nama}</td>
                    <td><input type="number" min="0" max="100" class="kriteria-input w-full p-2 bg-[var(--bg-muted)] rounded-md text-center" value="${penilaian.kriteria_1 || ''}" data-kriteria="1"></td>
                    <td><input type="number" min="0" max="100" class="kriteria-input w-full p-2 bg-[var(--bg-muted)] rounded-md text-center" value="${penilaian.kriteria_2 || ''}" data-kriteria="2"></td>
                    <td><input type="number" min="0" max="100" class="kriteria-input w-full p-2 bg-[var(--bg-muted)] rounded-md text-center" value="${penilaian.kriteria_3 || ''}" data-kriteria="3"></td>
                    <td><input type="text" placeholder="Catatan..." class="catatan-input w-full p-2 bg-[var(--bg-muted)] rounded-md" value="${penilaian.catatan || ''}"></td>
                    <td class="p-3 text-center font-bold text-lg text-[var(--text-primary)]">
                        <span class="nilai-akhir-display">${penilaian.nilai_akhir || '0'}</span>
                    </td>
                </tr>
            `;
        }).join('');

        container.innerHTML = `
            <table class="min-w-full text-sm">
                <thead class="bg-[var(--bg-muted)]"><tr>${tableHeader}</tr></thead>
                <tbody>${tableBody}</tbody>
            </table>
        `;
        actions.classList.remove('hidden');
    }

    function calculateNilaiAkhir(row) {
        const inputs = row.querySelectorAll('.kriteria-input');
        let total = 0;
        let count = 0;
        inputs.forEach(input => {
            const value = parseFloat(input.value);
            if (!isNaN(value)) {
                total += value;
                count++;
            }
        });
        const average = count > 0 ? (total / count).toFixed(2) : 0;
        row.querySelector('.nilai-akhir-display').textContent = average;
    }

    // =================================================================================
    // REKAP SISWA LOGIC
    // =================================================================================
    async function renderRekapSiswa() {
        const kelas = document.getElementById('rekap-siswa-kelas-filter').value;
        const siswaId = document.getElementById('rekap-siswa-murid-filter').value;
        const contentContainer = document.getElementById('rekap-siswa-content-container');
        
        if (kelas === '' || !siswaId) {
            contentContainer.innerHTML = `<p class="text-center p-8 text-[var(--text-secondary)] col-span-full">Silakan pilih kelas dan siswa untuk melihat rekapitulasi.</p>`;
            return;
        }
        
        contentContainer.innerHTML = `<p class="text-center p-8 text-[var(--text-secondary)] col-span-full">Memuat data rekapitulasi...</p>`;

        const siswa = allStudents.find(s => s.id == siswaId);
        if (!siswa) {
            contentContainer.innerHTML = `<p class="text-center p-8 text-red-500 col-span-full">Siswa tidak ditemukan.</p>`;
            return;
        }

        const periode = document.querySelector('#rekap-siswa-periode-filter .bg-slate-200, #rekap-siswa-periode-filter .dark\\:bg-slate-600').dataset.periode;
        const { startDate, endDate } = getPeriodeDates(periode, 'rekap-siswa');

        // Fetch Kehadiran
        const { data: attendanceData, error: attendanceError } = await supabase.from('kehadiran')
            .select('keterangan')
            .eq('siswa_id', siswaId)
            .gte('tanggal', startDate)
            .lte('tanggal', endDate);

        if (attendanceError) return showToast('Gagal memuat rekap kehadiran siswa.', true);

        const rekap = { Sakit: 0, Ijin: 0, Alpa: 0 };
        attendanceData.forEach(d => { if(rekap[d.keterangan] !== undefined) rekap[d.keterangan]++; });
        const totalHariEfektif = Math.round((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
        const hadir = totalHariEfektif - (rekap.Sakit + rekap.Ijin + rekap.Alpa);

        // Fetch Nilai
        const nilaiMap = {};
        allMapel.forEach(mapel => {
            const projectsInMapel = allProjek.filter(p => p.mapel_id === mapel.id);
            if (projectsInMapel.length === 0) return;

            projectsInMapel.forEach(projek => {
                const penilaian = allPenilaianProjek.find(n => n.siswa_id == siswaId && n.projek_id === projek.id);
                if (penilaian) {
                    if (!nilaiMap[mapel.nama_mapel]) nilaiMap[mapel.nama_mapel] = [];
                    nilaiMap[mapel.nama_mapel].push({ nama_projek: projek.nama_projek, nilai: penilaian.nilai_akhir });
                }
            });
        });

        let nilaiHTML = Object.keys(nilaiMap).length === 0 
            ? `<p class="text-center text-sm text-[var(--text-secondary)] py-4">Belum ada nilai.</p>`
            : Object.keys(nilaiMap).map(mapel => `
                <div class="p-3 bg-[var(--bg-muted)] rounded-lg">
                    <h4 class="font-bold text-[var(--text-primary)] text-base">${mapel}</h4>
                    <ul class="mt-2 space-y-1 text-sm">
                        ${nilaiMap[mapel].map(item => `
                            <li class="flex justify-between">
                                <span>${item.nama_projek}</span>
                                <span class="font-semibold text-[var(--text-primary)]">${item.nilai}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `).join('<div class="my-2"></div>');

        const rekapCardHTML = `
            <div class="bg-[var(--bg-card)] p-6 rounded-xl shadow-md border border-[var(--border-color)] lg:col-span-3">
                <h3 class="text-xl font-bold text-[var(--text-heading)]">${siswa.nama}</h3>
                <p class="text-sm text-[var(--text-secondary)] mb-4">NIS: ${siswa.nis} | Kelas: ${siswa.kelas}</p>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <h4 class="font-semibold text-[var(--text-primary)] mb-2">Rekap Kehadiran</h4>
                        <div class="h-48 flex justify-center items-center"><canvas id="rekap-chart-siswa-${siswa.id}"></canvas></div>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div class="p-1 text-center text-xs bg-green-100 dark:bg-green-900/50 rounded-md"><p class="text-green-700 dark:text-green-300">Hadir</p><p class="font-bold text-lg text-green-800 dark:text-green-200">${hadir}</p></div>
                            <div class="p-1 text-center text-xs bg-amber-100 dark:bg-amber-900/50 rounded-md"><p class="text-amber-700 dark:text-amber-300">Sakit</p><p class="font-bold text-lg text-amber-800 dark:text-amber-200">${rekap.Sakit}</p></div>
                            <div class="p-1 text-center text-xs bg-blue-100 dark:bg-blue-900/50 rounded-md"><p class="text-blue-700 dark:text-blue-300">Ijin</p><p class="font-bold text-lg text-blue-800 dark:text-blue-200">${rekap.Ijin}</p></div>
                            <div class="p-1 text-center text-xs bg-red-100 dark:bg-red-900/50 rounded-md"><p class="text-red-700 dark:text-red-300">Alpa</p><p class="font-bold text-lg text-red-800 dark:text-red-200">${rekap.Alpa}</p></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h4 class="font-semibold text-[var(--text-primary)] mb-2">Rekap Nilai Projek</h4>
                        <div class="space-y-2 h-64 overflow-y-auto p-1">${nilaiHTML}</div>
                    </div>
                </div>
            </div>
        `;
        contentContainer.innerHTML = rekapCardHTML;

        // Initialize chart for this student
        updateRekapSiswaChart(`rekap-chart-siswa-${siswa.id}`, [hadir, rekap.Sakit, rekap.Ijin, rekap.Alpa]);
    }

    function updateRekapSiswaChart(canvasId, data) {
        const ctx = document.getElementById(canvasId)?.getContext('2d');
        if (!ctx) return;
        
        if (rekapSiswaChartInstances[canvasId]) {
            rekapSiswaChartInstances[canvasId].destroy();
        }
        rekapSiswaChartInstances[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Hadir', 'Sakit', 'Ijin', 'Alpa'],
                datasets: [{
                    data: data,
                    backgroundColor: ['#22c55e', '#f59e0b', '#3b82f6', '#ef4444'],
                    borderColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '70%',
                plugins: { legend: { display: false } }
            }
        });
    }

    // =================================================================================
    // MANAJEMEN KELOMPOK LOGIC
    // =================================================================================
    function renderKelompokManagementUI() {
        // ... (fungsi tidak berubah)
    }
    
    // =================================================================================
    // SETTINGS LOGIC
    // =================================================================================
    function applySettings(settings) {
        const primaryColor = settings.primary_color || '#3b82f6';
        document.documentElement.style.setProperty('--primary-color', primaryColor);
        document.getElementById('color-picker').value = primaryColor;

        if (settings.logo_url) {
            document.getElementById('login-logo').src = settings.logo_url;
            document.getElementById('app-logo').src = settings.logo_url;
        }
        if (settings.background_url) {
            document.documentElement.style.setProperty('--background-image', `url('${settings.background_url}')`);
        }
    }

    async function loadAppSettings() {
        const { data, error } = await supabase.from('app_settings').select('*').eq('id', 1).single();
        if (data) {
            applySettings(data);
        }
    }

    // =================================================================================
    // EVENT LISTENERS
    // =================================================================================
    function setupEventListeners() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const menuButton = document.getElementById('menu-button');

        menuButton.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        });

        overlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(e.currentTarget.dataset.view);
                // Hide sidebar on mobile after navigation
                if (window.innerWidth < 1024) {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            });
        });

        document.getElementById('kelas-summary-body').addEventListener('click', (e) => {
            const summaryRow = e.target.closest('.summary-row');
            if (!summaryRow) return;
            const kelas = summaryRow.dataset.kelas;
            const detailRow = document.querySelector(`.detail-row[data-detail-for="${kelas}"]`);
            summaryRow.classList.toggle('expanded');
            detailRow.classList.toggle('hidden');
        });

        document.getElementById('rekap-kelas-filter').addEventListener('change', renderRekapKehadiran);
        
        const harianPicker = document.getElementById('rekap-harian-picker');
        const mingguanDisplay = document.getElementById('rekap-mingguan-display');
        const bulananPicker = document.getElementById('rekap-bulanan-picker');

        document.getElementById('rekap-periode-filter').addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            document.querySelectorAll('#rekap-periode-filter button').forEach(btn => {
                btn.classList.replace('bg-slate-200', 'bg-slate-100');
                btn.classList.replace('dark:bg-slate-600', 'dark:bg-slate-700');
            });
            e.target.classList.replace('bg-slate-100', 'bg-slate-200');
            e.target.classList.replace('dark:bg-slate-700', 'dark:bg-slate-600');
            
            const periode = e.target.dataset.periode;
            harianPicker.classList.toggle('hidden', periode !== 'harian');
            mingguanDisplay.classList.toggle('hidden', periode !== 'mingguan');
            bulananPicker.classList.toggle('hidden', periode !== 'bulanan');

            if (periode === 'mingguan') {
                const { startDate, endDate } = getPeriodeDates('mingguan');
                mingguanDisplay.textContent = `${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}`;
            }
            renderRekapKehadiran();
        });

        harianPicker.addEventListener('change', renderRekapKehadiran);
        bulananPicker.addEventListener('change', renderRekapKehadiran);
        
        document.getElementById('kehadiran-tanggal').addEventListener('change', renderInputKehadiranList);
        document.getElementById('kehadiran-kelas-filter').addEventListener('change', renderInputKehadiranList);
        document.getElementById('kehadiran-nama-filter').addEventListener('input', renderInputKehadiranList);
        document.getElementById('kehadiran-list-container').addEventListener('click', handleKehadiranClick);

        document.getElementById('siswa-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleExcelImport(file, 'siswa', (row) => {
                    if (!row['nis']) return null;
                    return { nis: String(row['nis']), nama: row['nama'], kelas: row['kelas'] };
                }, async () => {
                    await loadSiswaData();
                    populateClassFilters();
                    renderKelasSummaryTable();
                });
            }
        });
        
        const addMapelForm = document.getElementById('add-mapel-form');
        if(addMapelForm) {
            addMapelForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newMapelName = document.getElementById('new-mapel-name').value;
                const { error } = await supabase.from('mapel').insert({ nama_mapel: newMapelName });
                if (error) return showToast(`Gagal: ${error.message}`, true);
                showToast('Mapel baru ditambahkan!');
                addMapelForm.reset();
                await loadMapelData();
                populateMapelSelects();
            });
        }

        const addProjekForm = document.getElementById('add-projek-form');
        if(addProjekForm) {
            addProjekForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const mapelId = document.getElementById('projek-mapel-select').value;
                const newProjekName = document.getElementById('new-projek-name').value;
                const { error } = await supabase.from('projek').insert({ nama_projek: newProjekName, mapel_id: mapelId });
                if (error) return showToast(`Gagal: ${error.message}`, true);
                showToast('Projek baru ditambahkan!');
                addProjekForm.reset();
                await loadProjekData();
                populateLpProjekFilter();
            });
        }
        
        document.getElementById('rekap-nilai-kelas-filter').addEventListener('change', renderRekapNilaiProjek);
        document.getElementById('rekap-nilai-mapel-filter').addEventListener('change', renderRekapNilaiProjek);

        document.getElementById('export-nilai-projek').addEventListener('click', () => {
            const table = document.getElementById('rekap-nilai-table');
            if (!table) return showToast('Tidak ada data untuk di-export.', true);
            
            const wb = XLSX.utils.table_to_book(table, { sheet: "Rekap Nilai" });
            XLSX.writeFile(wb, "rekap_nilai_projek.xlsx");
        });

        document.getElementById('kelompok-kelas-filter').addEventListener('change', renderKelompokManagementUI);
        document.getElementById('kelompok-nama-filter').addEventListener('input', renderKelompokManagementUI);

        document.getElementById('add-kelompok-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const kelas = document.getElementById('kelompok-kelas-filter').value;
            if (kelas === '') return showToast('Pilih kelas terlebih dahulu.', true);

            const newKelompokName = document.getElementById('new-kelompok-name').value;
            const { error } = await supabase.from('kelompok').insert({ nama_kelompok: newKelompokName, kelas: kelas });
            if(error) return showToast(`Gagal: ${error.message}`, true);
            
            showToast('Kelompok baru berhasil dibuat!');
            e.target.reset();
            await loadKelompokData();
            renderKelompokManagementUI();
        });

        document.getElementById('unassigned-students-list').addEventListener('change', async (e) => {
            if (!e.target.matches('.add-to-kelompok-select')) return;
            
            const siswaId = e.target.dataset.siswaId;
            const kelompokId = e.target.value;

            if (!kelompokId) return;

            const { error } = await supabase.from('kelompok_anggota').insert({ siswa_id: siswaId, kelompok_id: kelompokId });
            if (error) return showToast(`Gagal menambahkan siswa: ${error.message}`, true);

            await loadKelompokAnggotaData();
            renderKelompokManagementUI();
        });

        document.getElementById('rekap-kelompok-container').addEventListener('click', async (e) => {
            const removeBtn = e.target.closest('.remove-from-kelompok-btn');
            if (!removeBtn) return;

            const anggotaId = removeBtn.dataset.anggotaId;
            const { error } = await supabase.from('kelompok_anggota').delete().eq('id', anggotaId);
            if (error) return showToast(`Gagal mengeluarkan siswa: ${error.message}`, true);

            await loadKelompokAnggotaData();
            renderKelompokManagementUI();
        });

        document.getElementById('save-settings').addEventListener('click', async () => {
            let logoUrl, backgroundUrl;
            const logoUpload = document.getElementById('logo-upload');
            const backgroundUpload = document.getElementById('background-upload');

            if (logoUpload.files[0]) {
                const file = logoUpload.files[0];
                const filePath = `public/logo_${Date.now()}`;
                const { error: uploadError } = await supabase.storage.from('assets').upload(filePath, file, { upsert: true });
                if (uploadError) { return showToast('Gagal mengupload logo: ' + uploadError.message, true); }
                const { data } = supabase.storage.from('assets').getPublicUrl(filePath);
                logoUrl = data.publicUrl;
            }
            if (backgroundUpload.files[0]) {
                const file = backgroundUpload.files[0];
                const filePath = `public/background_${Date.now()}`;
                const { error: uploadError } = await supabase.storage.from('assets').upload(filePath, file, { upsert: true });
                if (uploadError) { return showToast('Gagal mengupload background: ' + uploadError.message, true); }
                const { data } = supabase.storage.from('assets').getPublicUrl(filePath);
                backgroundUrl = data.publicUrl;
            }
            const updates = { id: 1, primary_color: document.getElementById('color-picker').value };
            if (logoUrl) updates.logo_url = logoUrl;
            if (backgroundUrl) updates.background_url = backgroundUrl;
            const { error } = await supabase.from('app_settings').upsert(updates);
            if (error) {
                showToast('Gagal menyimpan pengaturan: ' + error.message, true);
            } else {
                showToast('Pengaturan berhasil disimpan!');
                loadAppSettings(); // PERBAIKAN: Panggil fungsi ini untuk refresh UI
            }
        });
        
        document.getElementById('add-admin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('new-admin-email').value;
            const password = document.getElementById('new-admin-password').value;
            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) {
                showToast('Gagal menambah admin: ' + error.message, true);
            } else {
                // Also add to our public admin_users table
                const { error: insertError } = await supabase.from('admin_users').insert({ id: data.user.id, email: data.user.email });
                if(insertError) return showToast('User dibuat tapi gagal ditambahkan ke daftar.', true);
                
                showToast('Admin baru berhasil ditambahkan!');
                e.target.reset();
                await loadAdminData();
            }
        });

        document.getElementById('admin-list').addEventListener('click', async (e) => {
            const removeBtn = e.target.closest('.remove-admin-btn');
            if(!removeBtn) return;

            const adminId = removeBtn.dataset.adminId;
            // NOTE: Deleting a user from Supabase Auth requires an admin-level client,
            // which should NEVER be exposed on the front-end.
            // This implementation only removes the user from our public `admin_users` table for UI purposes.
            // A real-world application would require a secure serverless function to handle user deletion.
            if (confirm('Apakah Anda yakin ingin menghapus admin ini dari daftar? (Ini tidak akan menghapus akun login mereka)')) {
                const { error } = await supabase.from('admin_users').delete().eq('id', adminId);
                if(error) return showToast('Gagal menghapus admin dari daftar.', true);
                showToast('Admin berhasil dihapus dari daftar.');
                await loadAdminData();
            }
        });
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        let confirmAction = null;

        function showConfirmationModal(title, message, onConfirmCallback) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmAction = onConfirmCallback;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
            confirmAction = null;
        }

        modalCancelBtn.addEventListener('click', hideConfirmationModal);
        modalConfirmBtn.addEventListener('click', () => {
            if (typeof confirmAction === 'function') {
                confirmAction();
            }
            hideConfirmationModal();
        });

        document.getElementById('reset-nilai-button').addEventListener('click', () => {
            showConfirmationModal(
                'Reset Data Nilai',
                'Apakah Anda yakin ingin menghapus SEMUA data nilai projek? Tindakan ini tidak dapat diurungkan.',
                async () => {
                    await supabase.from('penilaian_projek').delete().neq('id', 0);
                    showToast('Semua data nilai berhasil direset.');
                    await loadPenilaianProjekData();
                    renderRekapNilaiProjek();
                }
            );
        });

        document.getElementById('reset-kehadiran-button').addEventListener('click', () => {
            showConfirmationModal(
                'Reset Data Kehadiran',
                'Apakah Anda yakin ingin menghapus SEMUA data kehadiran? Tindakan ini tidak dapat diurungkan.',
                async () => {
                    await supabase.from('kehadiran').delete().neq('id', 0);
                    showToast('Semua data kehadiran berhasil direset.');
                    await renderRekapKehadiran();
                }
            );
        });
        
        // Rekap Siswa Listeners
        const rekapSiswaKelasFilter = document.getElementById('rekap-siswa-kelas-filter');
        const rekapSiswaMuridFilter = document.getElementById('rekap-siswa-murid-filter');
        
        if (rekapSiswaKelasFilter) {
            rekapSiswaKelasFilter.addEventListener('change', (e) => {
                const selectedKelas = e.target.value;
                const muridSelect = document.getElementById('rekap-siswa-murid-filter');
                muridSelect.innerHTML = '<option value="">Pilih Siswa</option>';

                if (selectedKelas !== '') {
                    allStudents
                        .filter(s => s.kelas === selectedKelas)
                        .forEach(s => {
                            muridSelect.innerHTML += `<option value="${s.id}">${s.nama}</option>`;
                        });
                    muridSelect.classList.remove('hidden');
                } else {
                    muridSelect.classList.add('hidden');
                }
                renderRekapSiswa(); 
            });
        }
        
        if (rekapSiswaMuridFilter) {
            rekapSiswaMuridFilter.addEventListener('change', renderRekapSiswa);
        }

        document.getElementById('rekap-siswa-periode-filter').addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            document.querySelectorAll('#rekap-siswa-periode-filter button').forEach(btn => {
                btn.classList.replace('bg-slate-200', 'bg-slate-100');
                btn.classList.replace('dark:bg-slate-600', 'dark:bg-slate-700');
            });
            e.target.classList.replace('bg-slate-100', 'bg-slate-200');
            e.target.classList.replace('dark:bg-slate-700', 'dark:bg-slate-600');
            
            const periode = e.target.dataset.periode;
            document.getElementById('rekap-siswa-harian-picker').classList.toggle('hidden', periode !== 'harian');
            document.getElementById('rekap-siswa-mingguan-display').classList.toggle('hidden', periode !== 'mingguan');
            document.getElementById('rekap-siswa-bulanan-picker').classList.toggle('hidden', periode !== 'bulanan');

            if (periode === 'mingguan') {
                const { startDate, endDate } = getPeriodeDates('mingguan', 'rekap-siswa');
                document.getElementById('rekap-siswa-mingguan-display').textContent = `${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}`;
            }
            renderRekapSiswa();
        });
        document.getElementById('rekap-siswa-harian-picker').addEventListener('change', renderRekapSiswa);
        document.getElementById('rekap-siswa-bulanan-picker').addEventListener('change', renderRekapSiswa);

        // Lembar Penilaian Listeners
        const lpProjekFilter = document.getElementById('lp-projek-filter');
        const lpKelasFilter = document.getElementById('lp-kelas-filter');
        const lpKelompokFilter = document.getElementById('lp-kelompok-filter');

        lpKelasFilter.addEventListener('change', (e) => {
            const selectedKelas = e.target.value;
            lpKelompokFilter.innerHTML = '<option value="">Pilih Kelompok</option>';
            if (selectedKelas) {
                allKelompok.filter(k => k.kelas === selectedKelas).forEach(k => {
                    lpKelompokFilter.innerHTML += `<option value="${k.id}">${k.nama_kelompok}</option>`;
                });
            }
            renderLembarPenilaian();
        });
        lpProjekFilter.addEventListener('change', renderLembarPenilaian);
        lpKelompokFilter.addEventListener('change', renderLembarPenilaian);

        document.getElementById('lembar-penilaian-container').addEventListener('input', (e) => {
            if (e.target.matches('.kriteria-input')) {
                const row = e.target.closest('.penilaian-row');
                calculateNilaiAkhir(row);
            }
        });

        document.getElementById('save-penilaian-btn').addEventListener('click', async () => {
            const projekId = document.getElementById('lp-projek-filter').value;
            const kelompokId = document.getElementById('lp-kelompok-filter').value;
            const rows = document.querySelectorAll('.penilaian-row');
            const dataToSave = [];

            rows.forEach(row => {
                const siswaId = row.dataset.siswaId;
                const kriteria1 = row.querySelector('[data-kriteria="1"]').value;
                const kriteria2 = row.querySelector('[data-kriteria="2"]').value;
                const kriteria3 = row.querySelector('[data-kriteria="3"]').value;
                const catatan = row.querySelector('.catatan-input').value;
                const nilaiAkhir = row.querySelector('.nilai-akhir-display').textContent;

                dataToSave.push({
                    projek_id: projekId,
                    siswa_id: siswaId,
                    kelompok_id: kelompokId,
                    kriteria_1: kriteria1 ? parseFloat(kriteria1) : null,
                    kriteria_2: kriteria2 ? parseFloat(kriteria2) : null,
                    kriteria_3: kriteria3 ? parseFloat(kriteria3) : null,
                    catatan: catatan,
                    nilai_akhir: nilaiAkhir ? parseFloat(nilaiAkhir) : null,
                });
            });
            
            const { error } = await supabase.from('penilaian_projek').upsert(dataToSave, { onConflict: 'projek_id, siswa_id' });

            if (error) {
                return showToast(`Gagal menyimpan penilaian: ${error.message}`, true);
            }
            showToast('Penilaian berhasil disimpan!');
            await loadPenilaianProjekData();
        });
    }
    
    async function handleExcelImport(file, tableName, rowMapper, callback) {
        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (json.length === 0) return showToast('File Excel kosong.', true);
                
                const mappedData = json.map(rowMapper).filter(item => item !== null);
                const { error } = await supabase.from(tableName).upsert(mappedData, { onConflict: 'nis' });

                if (error) return showToast(`Gagal impor: ${error.message}`, true);
                showToast(`Berhasil mengimpor ${mappedData.length} baris data.`);
                if (callback) callback();
            } catch (e) { showToast(`Error memproses file: ${e.message}`, true); }
        };
        reader.readAsArrayBuffer(file);
    }

    // =================================================================================
    // START
    // =================================================================================
    checkSession();
});
</script>
</body>
</html>
